@page "/"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@using MySql.Data.MySqlClient
@using BlazorApp1.Data

@code {
    private bool _navigated = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _navigated) return;

        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "auth_token");
            if (string.IsNullOrWhiteSpace(token))
            {
                Navigation.NavigateTo("/registration");
                _navigated = true;
                return;
            }

            var connStr = "Server=31.31.197.28;Port=3310;Database=u3126643_flowers_db;User=u3126643_user_app;Password=xxxKKTX6815!;Charset=utf8mb4;SslMode=none;";
            using var conn = new MySqlConnection(connStr);
            await conn.OpenAsync();

            var cmd = new MySqlCommand("SELECT user_id FROM authtokens WHERE token = @token AND expires_at > NOW()", conn);
            cmd.Parameters.AddWithValue("@token", token);
            using var reader = await cmd.ExecuteReaderAsync();

            if (await reader.ReadAsync())
            {
                UserSession.CurrentUser = new User
                    {
                        Id = reader.GetInt32(0),
                        Username = reader.GetString(1),
                        Email = reader.GetString(2),
                        PasswordHash = reader.GetString(3),
                        Coins = reader.GetInt32(4)
                    };

                Navigation.NavigateTo("/main");
            }
            else
            {
                Navigation.NavigateTo("/registration");
            }

            _navigated = true;
        }
        catch
        {
            Navigation.NavigateTo("/registration");
            _navigated = true;
        }
    }
}
